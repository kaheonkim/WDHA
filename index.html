<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>WDHA Demos</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script>
    window.MathJax = {
      tex: {
        packages: {'[+]': ['bm']},
        macros: {
          bbNabla: "\\nabla\\mkern-12mu\\nabla"
        }
      }
    };
  </script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      max-width: 1000px;
      margin: auto;
      padding: 2rem;
      background-color: #fafafa;
      color: #333;
    }

    h1 {
      font-size: 2.2rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }

    h2 {
      font-size: 1.3rem;
      text-align: center;
      font-weight: 400;
      margin-top: 0;
      margin-bottom: 2rem;
      color: #666;
    }

    h3 {
      margin-top: 2rem;
      font-size: 1.5rem;
    }

    h4 {
      font-size: 1.2rem;
      margin-top: 1.5rem;
      color: #444;
    }

    ul {
      list-style-type: disc;
      padding-left: 2rem;
    }

    li {
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    a {
      text-decoration: none;
      color: #0066cc;
      font-weight: 600;
    }

    a:hover {
      text-decoration: underline;
    }

    .highlight {
      font-family: "Source Code Pro", monospace;
      background-color: #fff5f5;
      border: 1px solid #ffcccc;
      border-radius: 3px;
      padding: 0.05em 0.3em;
      font-size: 0.9em;
      color: #cc0000;
    }

    figure {
      text-align: center;
      margin: 1rem auto;
    }

    figcaption {
      margin-top: 0.5rem;
      font-style: italic;
      color: #555;
    }

    img {
      width: 300px;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    .paper-box {
      margin-bottom: 2rem;
      padding: 1rem;
      background-color: #f0f0f0;
      border: 2px solid #0066cc;
      border-radius: 8px;
      text-align: left;
    }

    .container {
      display: flex;
      max-width: 1000px;
      margin: auto;
      gap: 2rem;
    }
    .sidebar {
      width: 250px; /* 사이드바의 너비를 좁힙니다 */
      background-color: #ecf0f1;
      color: white;
      padding: 20px;
      position: fixed; /* 고정 위치 */
      top: 0;
      left: 0;
      height: 100%;
    }

    .main-content {
      margin-left: 50px; /* 사이드바 너비만큼 왼쪽 여백 추가 */
      padding: 20px;
      width: calc(100% - 50px); /* 사이드바 너비를 제외한 나머지 공간을 사용 */
      background-color: white;
    }

    .sidebar h4 {
      margin-bottom: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #ccc;
      padding-bottom: 0.3rem;
    }

    .sidebar ul {
      list-style: none;
      padding-left: 0;
    }

    .sidebar ul li {
      margin: 0.5rem 0;
    }

    .sidebar ul ul {
      margin-left: 1rem;
      font-size: 0.95rem;
    }

    .sidebar a {
      text-decoration: none;
      color: #007bff;
      transition: color 0.3s, background-color 0.3s;
      padding: 4px 8px;
      display: inline-block;
      border-radius: 6px;
    }

    .sidebar a:hover {
      background-color: #e9ecef;
      color: #0056b3;
    }

    .markdown-cell { margin: 1em 0; line-height: 1.6; }
    .code-cell { background: #f5f5f5; border-left: 5px solid #007acc; padding: 1em; margin: 1em 0; font-family: monospace; white-space: pre-wrap; }
  </style>
</head>

<body>

  <div class="container">
    <div class="sidebar">
      <h4>Contents</h4>
      <ul>
        <li><a href="#intro">1. Introduction</a>
          <ul>
            <li><a href="#intro-1">1.1 Formulation</a></li>
            <li><a href="#intro-2">1.2 Algorithm</a></li>
          </ul>
        </li>
        <li><a href="#impl">2. Implementation</a>
          <ul>
            <li><a href="#impl-1">2.1 Uniform Distributions with Varying Support</a></li>
            <li><a href="#impl-2">2.2 High-resolution Handwritten Digit Images</a></li>
          </ul>
        </li>
      </ul>
    </div>
  <div class="main-content">
    <header>
      <h1>Wasserstein Descent \( \dot{\mathbb{H}}^1 \)-Ascent (WDHA) Documentation</h1>
    </header>

  <p>Welcome to WDHA Documentation! This documentation describes the implementation for "Wasserstein Descent \( \dot{\mathbb{H}}^1 \)-Ascent (WDHA) algorithm" for computing Optimal Transport Barycenter (a.k.a Wasserstein Barycenter) introduced in our paper:</p>

  <div class="paper-box">
    <strong>
      "Optimal Transport Barycenter via Nonconvex-Concave Minimax Optimization"<a href="https://arxiv.org/pdf/2501.14635" target="_blank"> [Link]</a>
    </strong><br>
    <em>Kaheon Kim, Rentian Yao, Changbo Zhu, and Xiaohui Chen</em><br>
    <em>International Conference on Machine Learning (ICML), 2025</em>
  </div>
  This documentation shows implementations for 2D probability densities done in <strong>Section 4.Numerical Studies</strong> of the paper. 
  Full version of codes listed in the <a href="https://github.com/kaheonkim/WDHA">repository</a> provide detailed comparison and analysis for the examples with Sinkhorn-type methods in the paper.

  <section id="intro">
    <h3>1. Introduction</h3>
    <section id="intro-1">
      <h4>1.1. Formulation</h4>
      <p>Combining with Kantorovich formulation, We approach Wasserstein barycenter problem as nonconvex-concave minimax problem between Wasserstein space and Sobolev space.</p>
      <div>
        \[
        \begin{align*}
        \bar{\mu} &= \arg\min_{\nu\in\mathcal{P}(\Omega)}\frac{1}{n}\sum_{i=1}^nW_2^2(\nu,\mu_i) \\
        &= \arg\min_{\nu\in\mathcal{P}(\Omega)}\frac{1}{n}\sum_{i=1}^n\max_{\varphi_i : \text{convex}} 
        \underbrace{
        \int\left(\frac{\|x\|_2^2}{2}-\varphi_i(x)\right) d\nu(x) + 
        \int\left(\frac{\|y\|_2^2}{2}-\varphi_i^*(y)\right) d\mu_i(y)
        }_{\mathcal{I}_{\nu}^{\mu_i}(\varphi_i)}
        \end{align*}
        \]
      </div>
    </section>
    <section id="intro-2">
      <h4>1.2. Algorithm</h4>
      <p>To tackle this minimax problem, we introduce Wasserstein Descent \( \dot{\mathbb{H}}^1 \)-Ascent (WDHA) algorithm:</p>
      <p style="text-align: center;">
        <img src="examples/images/alg2.png" alt="WDHA Algorithm" style="width: 100%; height: auto; max-width: 700px;">
      </p>

      <ul>
        <li>Wasserstein Gradient: \(\boldsymbol{\nabla} \mathcal{J}(\nu, \boldsymbol{\varphi}) = \text{id} - \nabla \bar{\varphi}, \text{ where } \bar{\varphi} = \frac{1}{n}\sum_{i=1}^n \varphi_i\)</li>
        <li>\(\dot{\mathbb{H}}^1\)-Gradient: \(\bbNabla_{\varphi_i} \mathcal{J}(\nu, \boldsymbol{\varphi}) = \frac{1}{n}(-\Delta)^{-1}(-\nu + (\nabla \varphi_i^*)_\# \mu_i)\)</li>
        <li>Convex Hull: \( (\cdot)^{**}\) where \( f^*(y) = \sup_{x\in \Omega} \left< x,y \right>-f(x)\) with \(f:\Omega\rightarrow \mathbb{R}\)</li>
      </ul>
    </section>
  </section>
</section id ="Implementation">
  <h3>2. Implementation</h3>
   <p>The function for WDHA is built based on the core functionality (c-transform and pushforward measure) provided by Flavien Leger in the
  <a href="https://github.com/Math-Jacobs/bfm">BFM package</a>.</p>
  <pre class="code-cell"><code>
  !git clone https://github.com/Math-Jacobs/bfm
  !pip install bfm/python
  !pip install pot
  !wget -O functions.py https://raw.githubusercontent.com/kaheonkim/WDHA/main/implementation2D/functions.py
  !wget -O metric.py https://raw.githubusercontent.com/kaheonkim/WDHA/main/implementation2D/metric.py</code></pre>
  

  <pre class="code-cell"><code>
  import numpy as np
  from metric import *
  from functions import *
  
  %config InlineBackend.figure_format = 'retina'
  plt.rcParams['figure.figsize'] = (13, 8)
  plt.rcParams['image.cmap'] = 'viridis'</code></pre>
  <section id="impl-1">
    <h4>2.1. Uniform Distributions with Varying Support</h4>
    <p>
      Four distinct shapes are placed at four different locations: a square at the top-left, a heart at the bottom-left, a cross at the bottom-right, and a circle at the top-right. 
      These shapes represent four uniform probability densities with distinct supports. We demonstrate the application of WDHA on these four synthetic uniform distributions.
    </p>
    <pre class="code-cell"><code>
  n1, n2 = 1024, 1024
  x, y = np.meshgrid(np.linspace(0.5/n1, 1-0.5/n1, n1),
                     np.linspace(0.5/n2, 1-0.5/n2, n2))
  r = 0.1
  # Initialize densities
  mu1 = np.zeros((n2, n1))
  mu1[(x-0.8)**2 + (y-0.8)**2 &lt; r**2] = 1
  mu2 = np.zeros((n2, n1))
  mu2[(0.8-r/2.5 &lt; x) &amp; (x &lt; 0.8+r/2.5) &amp; (0.3-r &lt; y) &amp; (y &lt; 0.3+r)] = 1
  mu2[(0.3-r/2.5 &lt; y) &amp; (y &lt; 0.3+r/2.5) &amp; (0.8-r &lt; x) &amp; (x &lt; 0.8+r)] = 1
  
  # Normalize
  mu1 *= n1*n2 / np.sum(mu1)
  mu2 *= n1*n2 / np.sum(mu2)
  
  heart = np.zeros((n2, n1))
  heart[((10*x-2)**2+(10*(y-0.3))**2-1)**3 - (10*x-2)**2*(10*(y-0.3))**3 &lt; 0] = 1
  heart *= n1 * n2 / np.sum(heart)
  
  rectangle = np.zeros((n2, n1))
  rectangle[(x &lt; 0.3) &amp; (x &gt; 0.1) &amp; (y &gt; 0.7) &amp; (y &lt; 0.9)] = 1
  rectangle *= n1*n2 / np.sum(rectangle)
  
  mu = [mu1, mu2, heart, rectangle]
  plotting(mu, np.zeros((n2,n1)), '_', save_option=False)</code></pre>
  
      <figure>
        <img src="examples/images/uniform/original.png" alt="4 Uniform Densities"  style="width: 50%; height: auto;">>
        <figcaption>4 Uniform Densities</figcaption>
      </figure>
      The Wasserstein Barycenter for 4 uniform distributions computed by WDHA:
  
    <pre class="code-cell"><code>mu_WGHA = frechet_mean(mu, 300, 'MU', save_option=False, return_option=True)</code></pre>
  
    <figure>
      <img src="examples/images/uniform/wdha.png" alt="WDHA Barycenter"  style="width: 50%; height: auto;">>
      <figcaption>Wasserstein Barycenter computed by WDHA</figcaption>
    </figure>
    You can directly run the code for this example with <a href=https://colab.research.google.com/drive/1_pGVv7BuWnXBsK_-2H9Z7EE1PzXssNXH> Google Colab Notebook</a>.
  </section>
  
  <section id="impl-2">
    <h4>2.2. High-resolution Handwritten Digit Images</h4>
    <p>
      WDHA is applied to the barycenter problem using 100 high-resolution (500×500) images of the digit 8, provided by Cédric Beaulac and Jeffrey S. Rosenthal 
      in their preprint "Analysis of a high-resolution hand-written digits data set with writer characteristics". The dataset — 
       <span class="highlight">Images(500x500).npy</span> and <span class="highlight">WriterInfo.npy</span> — is available at the following <a href="https://drive.google.com/drive/folders/1f2o1kjXLvcxRgtmMMuDkA2PQ5Zato4Or">link</a>. 
    <pre class="code-cell"><code>
  Images = np.load('/content/drive/My Drive/WDHA/Images(500x500).npy')
  WriterInfo = np.load('/content/drive/My Drive/WDHA/WriterInfo.npy')
  digit = WriterInfo[:, 0]
  user = WriterInfo[:, -1]
  num_image = 100
  num_iter = 300
  numbers8 = 255 - Images[(digit == 8)][:num_image].astype('float64')
  
  for j in range(num_image):
      numbers8[j] /= np.sum(numbers8[j])
      numbers8[j] *= 500 * 500
  del Images, WriterInfo, user, digit</code></pre>
  
    <pre class="code-cell"><code>
  fig, axes = plt.subplots(1, 3, figsize=(10, 4))  # 3 rows, 1 column
  
  plotting_mnist(numbers8[0], '', ax=axes[0])
  plotting_mnist(numbers8[1], '', ax=axes[1])
  plotting_mnist(numbers8[2], '', ax=axes[2])
  
  plt.tight_layout()
  plt.show()</code></pre>
  
    <figure style="flex: 1;">
      <img src="examples/images/digits/original.png" alt="Exemplary Digits 8" style="width: 100%; height: auto;">
      <figcaption>Exemplary Digits 8</figcaption>
    </figure>
  
    <div class="markdown-cell">
      The Wasserstein Barycenter for 100 handwritten images of digit 8 computed by WDHA:
    </div>
  
    <pre class="code-cell"><code>
  bary8 = frechet_mean(numbers8, num_iter, 'mnist', plot_option=False, save_option=False, return_option=True)
  plotting_mnist(bary8, '')</code></pre>
  
    <figure style="flex: 1;">
      <img src="examples/images/digits/wdha.png" alt="WDHA Barycenter of Digits" style="width: 50%; height: auto;">>
      <figcaption>Wasserstein Barycenter computed by WDHA</figcaption>
    </figure>
  </section>
</section>
</div>
</div>
</body>

</html>
